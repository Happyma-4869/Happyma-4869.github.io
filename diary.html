<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>Happy çš„å…¬å…±æ—¥è®°</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body {
      font-family: Arial;
      background: #0f172a;
      color: white;
      padding: 20px;
    }
    textarea, input, button {
      margin: 5px 0;
      width: 100%;
      padding: 8px;
    }
    .diary {
      background: #1e293b;
      padding: 10px;
      margin: 10px 0;
      border-radius: 8px;
    }
    .btn {
      margin-right: 5px;
    }
  </style>
</head>
<body>

<h2>ğŸ“˜ Happy çš„å…¬å…±æ—¥è®°</h2>

<textarea id="content" placeholder="å†™ä¸‹ä½ çš„æ—¥è®°..."></textarea>
<input id="password" placeholder="å¯é€‰ï¼šè®¾ç½®å¯†ç ">
<button onclick="addDiary()">å‘å¸ƒæ—¥è®°</button>

<hr>

<button onclick="exportTXT()">ğŸ“¤ å¯¼å‡º TXT</button>
<button onclick="exportPDF()">ğŸ“¤ å¯¼å‡º PDF</button>

<div id="list"></div>

<script>
  // 
  const SUPABASE_URL = "https://ydpqboowpfijppwgrals.supabase.co";
  const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlkcHFib293cGZpanBwd2dyYWxzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUxNDI0NjAsImV4cCI6MjA4MDcxODQ2MH0.6uF8nCdjVzaevZroBoA7isiVWAZ6k5LXlAwQrbuYWYM";

  const supabase = supabaseJs.createClient(SUPABASE_URL, SUPABASE_KEY);

  async function addDiary() {
    const content = document.getElementById("content").value;
    const password = document.getElementById("password").value;

    if (!content) return alert("ä½ èµ·ç å†™ä¸€å¥");

    const encrypted = password ? btoa(content) : content;

    await supabase.from("diary").insert([
      { content: encrypted, locked: !!password, password: password }
    ]);

    document.getElementById("content").value = "";
    document.getElementById("password").value = "";
    loadDiary();
  }

  async function loadDiary() {
    const { data } = await supabase.from("diary").select().order("id", { ascending: false });
    const list = document.getElementById("list");
    list.innerHTML = "";

    data.forEach(item => {
      const div = document.createElement("div");
      div.className = "diary";

      let text = item.locked ? "ğŸ” å·²åŠ å¯†å†…å®¹" : item.content;

      div.innerHTML = `
        <p>${text}</p>
        <button class="btn" onclick="deleteDiary(${item.id})">âŒ åˆ é™¤</button>
        <button class="btn" onclick="editDiary(${item.id}, '${item.locked}')">âœï¸ ç¼–è¾‘</button>
        ${item.locked ? `<button onclick="unlock(${item.id}, '${item.password}', '${item.content}')">ğŸ”“ è§£é”</button>` : ""}
      `;
      list.appendChild(div);
    });
  }

  async function deleteDiary(id) {
    await supabase.from("diary").delete().eq("id", id);
    loadDiary();
  }

  async function editDiary(id, locked) {
    const newText = prompt("ä¿®æ”¹å†…å®¹ï¼š");
    if (!newText) return;

    const finalText = locked === "true" ? btoa(newText) : newText;

    await supabase.from("diary").update({ content: finalText }).eq("id", id);
    loadDiary();
  }

  function unlock(id, pass, raw) {
    const input = prompt("è¾“å…¥å¯†ç ï¼š");
    if (input === pass) {
      alert(atob(raw));
    } else {
      alert("å¯†ç é”™è¯¯");
    }
  }

  async function exportTXT() {
    const { data } = await supabase.from("diary").select();
    let text = data.map(d => d.locked ? "[åŠ å¯†æ—¥è®°]" : d.content).join("\n\n");

    const blob = new Blob([text]);
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "diary.txt";
    a.click();
  }

  async function exportPDF() {
    const { data } = await supabase.from("diary").select();
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    let y = 10;

    data.forEach(d => {
      doc.text(d.locked ? "[åŠ å¯†æ—¥è®°]" : d.content, 10, y);
      y += 10;
    });

    doc.save("diary.pdf");
  }

  loadDiary();
</script>

</body>
</html>
