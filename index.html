<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>Happy çš„ä¸ªäººä¸»é¡µï¼ˆä¼˜åŒ–å®Œæ•´ç‰ˆï¼‰</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

<!-- FontAwesome 4 for Valine icons (Valine ä½¿ç”¨æ—§ç‰ˆå›¾æ ‡) -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css">

<style>
/* ---------------- åŸºç¡€ ---------------- */
:root{--accent1:#5ac8fa;--accent2:#007aff;}
body, html {margin:0; padding:0; font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",sans-serif; color:#333; overflow-x:hidden; transition: color 0.5s, filter 0.3s; scroll-behavior: smooth; background: linear-gradient(180deg,#f6f8fb 0%, #ffffff 100%);} 
body.dark { color:#eee; background: linear-gradient(180deg,#0b1220 0%, #071026 100%);} 
a { text-decoration:none; color:inherit; }
section { position:relative; z-index:2; }

/* ---------------- èƒŒæ™¯è§†é¢‘ ---------------- */
#bgVideo {position:fixed; top:0; left:0; width:100%; height:100%; object-fit:cover; z-index:0; opacity:0; animation: fadeIn 1s forwards; transition: filter 0.5s;}
body.dark #bgVideo { filter: brightness(35%) contrast(110%) saturate(120%); }
@keyframes fadeIn { to { opacity:1; } }

/* ---------------- åŠé€æ˜å¤œé—´æ»¤é•œ ---------------- */
body.dark::before { content:''; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,40,0.25); z-index:1; pointer-events:none; }

/* ---------------- ç²’å­ç”»å¸ƒ ---------------- */
#particles { position:fixed; top:0; left:0; width:100%; height:100%; pointer-events:none; z-index:0; }

/* ---------------- è‹¹æœé£æ ¼å¡ç‰‡ ---------------- */
.card { background: linear-gradient(to bottom right, rgba(255,255,255,0.6), rgba(245,245,245,0.4)); backdrop-filter: blur(20px); border-radius: 25px; box-shadow: 0 12px 30px rgba(0,0,0,0.08); padding:20px; display:flex; flex-direction:column; gap:12px; width:320px; margin:0 auto 24px; opacity:0; transform: translateY(20px); transition: transform 0.6s cubic-bezier(0.5,0,0.1,1), opacity 0.6s, box-shadow 0.4s, background 0.5s;}
.card.show { opacity:1; transform: translateY(0); }
.card:hover { transform: translateY(-6px); box-shadow: 0 18px 48px rgba(0,0,0,0.12); }
body.dark .card { background: rgba(30,30,30,0.85); color:#fff; box-shadow:0 12px 30px rgba(255,255,255,0.03); }

/* ---------------- å¡ç‰‡å†…æ ‡ç­¾ ---------------- */
.card .tags { margin-top:10px; text-align:center; }
.card .tag { display:inline-block; background:linear-gradient(45deg,var(--accent1),var(--accent2)); color:white; padding:5px 10px; margin:3px; border-radius:15px; font-size:12px; transition: transform 0.2s, box-shadow 0.3s; }
.card .tag:hover { transform:scale(1.05); box-shadow:0 6px 18px rgba(0,0,0,0.15); }

/* ---------------- å¤´éƒ¨ ---------------- */
header { text-align:center; padding:56px 20px 14px; position:relative; z-index:2;}
header img { width:140px; height:140px; border-radius:50%; border:4px solid rgba(255,255,255,0.8); margin-bottom:18px; transition: transform 0.3s, box-shadow 0.3s; }
header img:hover {transform:scale(1.06); box-shadow:0 8px 30px rgba(0,0,0,0.18);}
header h1, header p { color: inherit; margin:0;}
header h1{margin:8px 0; font-size:34px;}
header p{font-size:16px; margin:6px 0;}

/* ---------------- è®¿å®¢é‡ ---------------- */
#visitorCard { background: linear-gradient(to bottom right, rgba(255,255,255,0.5), rgba(240,240,240,0.4)); backdrop-filter: blur(12px); border-radius:18px; padding:8px 16px; display:inline-block; margin-top:10px; font-weight:600; box-shadow: 0 8px 20px rgba(0,0,0,0.08); transition: transform 0.25s, box-shadow 0.25s; }
#visitorCard:hover { transform: scale(1.05); box-shadow: 0 12px 30px rgba(0,0,0,0.12); }

/* ---------------- å¯¼èˆª ---------------- */
nav { margin-top:18px; background:rgba(255,255,255,0.18); padding:8px 12px; position:sticky; top:14px; z-index:5; border-radius:18px; display:inline-block; transition:0.3s; }
nav.scrolled { background:rgba(0,0,0,0.45); box-shadow:0 6px 18px rgba(0,0,0,0.28); }
nav a { margin:0 12px; font-weight:700; color:inherit; }
nav a.active { color:#ffeb3b;}
nav a:hover { color:#ffeb3b; }

/* ---------------- æ—¥å¤œåˆ‡æ¢æŒ‰é’® ---------------- */
#modeToggle { position:fixed; top:18px; right:18px; padding:8px 14px; background:linear-gradient(135deg,var(--accent1),var(--accent2)); color:white; border-radius:22px; cursor:pointer; z-index:10; transition:0.25s, transform 0.18s; }
#modeToggle:hover { background:linear-gradient(135deg,var(--accent2),var(--accent1)); transform: scale(1.04); }

/* ---------------- è¿”å›é¡¶éƒ¨ ---------------- */
#toTopBtn { position:fixed; bottom:28px; right:28px; background:linear-gradient(135deg,var(--accent1),var(--accent2)); color:white; border:none; padding:10px 14px; border-radius:22px; cursor:pointer; font-size:15px; z-index:10; display:none; transition:0.3s, transform 0.18s, box-shadow 0.3s; }
#toTopBtn:hover { background:linear-gradient(135deg,var(--accent2),var(--accent1)); transform:scale(1.05); box-shadow:0 10px 30px rgba(0,0,0,0.2); }
#toTopBtn:active { transform:scale(0.96); }

/* ---------------- è”ç³»æˆ‘ ---------------- */
.contact .qr { display:flex; justify-content:center; margin-top:16px; }
.contact .qr img { width:140px; height:140px; border-radius:16px; border:2px solid #ddd; cursor:pointer; transition:0.28s, transform 0.2s, box-shadow 0.3s;}
.contact .qr img:hover { transform:scale(1.06); box-shadow:0 10px 28px rgba(0,0,0,0.18); }

/* ---------------- å¼¹çª— ---------------- */
#qrModal { display:none; position:fixed; z-index:20; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.45); justify-content:center; align-items:center; }
#qrModal img { max-width:320px; border-radius:16px; border:3px solid #fff; transition: transform 0.28s ease, opacity 0.28s ease; opacity:0; }
#qrModal.show { display:flex; }
#qrModal.show img { transform: scale(1.03); opacity:1; }

/* ---------------- åˆ†åŒº ---------------- */
section { padding:54px 18px; text-align:center; }
section h2 { font-size:26px; color:var(--accent2); margin-bottom:22px; }

textarea, input[type="date"], input[type="text"] { width:94%; padding:10px; border-radius:16px; border:none; box-shadow: inset 0 2px 6px rgba(0,0,0,0.06); resize:none; margin:0 auto; display:block; }
.diary-actions { display:flex; justify-content:center; gap:10px; margin-top:10px; }
.diary-actions button, #addDiaryBtn { padding:8px 12px; cursor:pointer; border:none; border-radius:20px; background:linear-gradient(135deg,var(--accent1),var(--accent2)); color:white; font-weight:700; transition:0.28s, transform 0.18s, box-shadow 0.28s; }
.diary-actions button:hover, #addDiaryBtn:hover { background:linear-gradient(135deg,var(--accent2),var(--accent1)); transform:scale(1.04); box-shadow:0 10px 30px rgba(0,0,0,0.18); }

/* ---------------- Valine ç”µè„‘ç«¯è°ƒæ•´ & å¤œé—´è¾“å…¥ä¿®å¤ ---------------- */
#vcomments .vcontainer .vinput i { margin-right:6px; vertical-align: middle; font-size:16px; color:#666; }
#vcomments .vcontainer .vsubmit { background-color:var(--accent2) !important; color:#fff !important; border-radius:20px; padding:8px 16px; }
#vcomments { max-width:760px; margin:20px auto 40px; padding:14px; border-radius:18px; background: rgba(255,255,255,0.88); backdrop-filter: blur(8px); box-shadow:0 12px 30px rgba(0,0,0,0.06); }
body.dark #vcomments { background: rgba(18,18,18,0.75); }
body.dark #vcomments .vcontainer .vinput input, body.dark #vcomments .vcontainer .vinput textarea { background:#121212; color:#fff; }

/* Valine åœ¨å¤§å±å¹•æ˜¾ç¤ºä¸ºå¡ç‰‡é£æ ¼ */
@media (min-width:769px) {
  #vcomments { padding:18px; }
  #vcomments .vcontainer .vinput input[type="text"], #vcomments .vcontainer .vinput input[type="email"], #vcomments .vcontainer .vinput input[type="url"] { height:40px; border-radius:18px; padding:8px 12px; font-size:15px; }
  #vcomments .vcontainer .vinput textarea { min-height:110px; border-radius:14px; padding:10px; font-size:15px; }
  #vcomments .vcontainer .vinput .vfield { display:inline-block; vertical-align:middle; margin-right:10px; }
  #vcomments .vcontainer .vinput .vfield.vmeta { width:26%; }
  #vcomments .vcontainer .vinput .vfield.vmsg { width:68%; }
  #vcomments .vcontainer .vcomment { max-width:720px; margin:12px auto; border-radius:14px; padding:12px; background: rgba(255,255,255,0.95); box-shadow:0 8px 20px rgba(0,0,0,0.06); }
  body.dark #vcomments .vcontainer .vcomment { background: rgba(50,50,50,0.7); color:#fff; box-shadow:none; }
}

/* ---------------- å“åº”å¼ä¼˜åŒ– ---------------- */
@media (max-width:400px){ header img { width:84px; height:84px; } header h1 { font-size:22px; } header p { font-size:13px; } .card { width:92%; padding:16px; margin-bottom:22px; } nav a { margin:0 6px; font-size:12px; } #modeToggle,#toTopBtn,button{ padding:6px 10px; font-size:13px; } }
@media (min-width:401px) and (max-width:768px){ header img { width:110px; height:110px; } header h1 { font-size:28px; } header p { font-size:15px; } .card { width:86%; padding:18px; margin-bottom:26px; } nav a { margin:0 10px; font-size:14px; } }
@media (min-width:769px){ header img { width:140px; height:140px; } header h1 { font-size:34px; } header p { font-size:16px; } .card { width:320px; padding:20px; margin-bottom:32px; } nav a { margin:0 14px; font-size:15px; } }

/* ---------------- å°æç¤ºæ¡ ---------------- */
#toast{ position:fixed; left:50%; transform:translateX(-50%); bottom:20px; z-index:40; background:rgba(0,0,0,0.7); color:#fff; padding:10px 16px; border-radius:12px; display:none; }

/* ---------------- æ—¥è®°å¡ç‰‡å†…å›¾ç‰‡ ---------------- */
.diary-img { width:100%; border-radius:12px; margin-top:8px; }

</style>
</head>
<body>

<video id="bgVideo" autoplay muted loop playsinline>
  <source src="https://github.com/Happyma-4869/Happyma-4869.github.io/raw/refs/heads/main/Video%20Project%204.mp4" type="video/mp4">
</video>
<canvas id="particles"></canvas>

<header>
  <img src="https://github.com/Happyma-4869/Happyma-4869.github.io/blob/main/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20251207233412_9_79.jpg?raw=true" alt="å¤´åƒ" id="avatar">
  <h1>æ¬¢è¿æ¥åˆ° Happy çš„ä¸»é¡µ</h1>
  <p>è®°å½•æˆ‘çš„æ—¥å¸¸å’Œç‚¹æ»´ ğŸ˜Š</p>
  <div id="visitorCard">è®¿å®¢é‡ï¼š<span id="visitorCount">0</span></div>
  <nav id="mainNav">
      <a href="#about">å…³äºæˆ‘</a>
      <a href="#diary">æ—¥è®°</a>
      <a href="#comments">ç•™è¨€åŒº</a>
      <a href="#contact">è”ç³»æˆ‘</a>
  </nav>
</header>

<div id="modeToggle" title="åˆ‡æ¢æ—¥/å¤œ">ğŸŒ™ æ—¥/å¤œåˆ‡æ¢</div>
<button id="toTopBtn" title="å›åˆ°é¡¶éƒ¨">â¬†ï¸ é¡¶éƒ¨</button>

<section id="about">
  <h2>å…³äºæˆ‘</h2>
  <div class="card show">
    <p>Hi æˆ‘æ˜¯ Happyï¼Œæˆ‘æ¥è‡ªæ²³å—éƒ‘å·å¸‚ï¼Œç›®å‰æ˜¯éƒ‘å·å¸‚è¥¿äºšæ–¯å¤§ä¸€å­¦ç”Ÿã€‚åœ¨æ­¤æˆ‘æƒ³åˆ†äº«æˆ‘çš„ç”Ÿæ´»</p>
    <div class="tags"><span class="tag">æ¸¸æˆ</span><span class="tag">å‰ç«¯çˆ±å¥½</span><span class="tag">æ—¥å¸¸è®°å½•</span></div>
  </div>
</section>

<section id="diary">
  <h2>æˆ‘çš„æ—¥è®° ğŸ“–</h2>
  <div class="card" id="diaryFormCard">
    <input type="date" id="diaryDate" />
    <textarea id="diaryContent" placeholder="å†™ä¸‹ä»Šå¤©çš„æ—¥è®°..." rows="4"></textarea>
    <input type="file" id="diaryImg" accept="image/*" />
    <!-- å›¾ç‰‡é¢„è§ˆåŒºåŸŸ -->
    <div id="imgPreviewWrap"></div>
    <div class="diary-actions">
      <button id="addDiaryBtn">æ·»åŠ æ—¥è®°</button>
      <button id="clearFormBtn" type="button">æ¸…ç©º</button>
    </div>
  </div>
  <div id="diaryList"></div>
</section>

<section id="comments">
  <h2>ç•™è¨€åŒº ğŸ’¬</h2>
  <div id="vcomments" class="card" style="max-width:760px; margin:0 auto 40px;"></div>
</section>

<section id="contact">
  <h2>è”ç³»æˆ‘</h2>
  <p>å¾®ä¿¡ï¼š<strong>H4ppy_ma</strong></p>
  <p>QQé‚®ç®±ï¼š<strong>1348790438@qq.com</strong></p>
  <div class="contact">
      <div class="qr">
          <img id="qrImg" src="https://github.com/Happyma-4869/Happyma-4869.github.io/blob/main/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20251207233522_10_79.jpg?raw=true" alt="å¾®ä¿¡äºŒç»´ç ">
      </div>
  </div>
</section>

<footer style="text-align:center;padding:18px 0;">&copy; 2025 Happyma.top</footer>
<div id="qrModal"><img src="https://github.com/Happyma-4869/Happyma-4869.github.io/blob/main/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20251207233522_10_79.jpg?raw=true" alt="å¾®ä¿¡äºŒç»´ç å¤§å›¾"></div>
<div id="toast"></div>

<!-- LeanCloud SDK -->
<script src="https://cdn.jsdelivr.net/npm/leancloud-storage@4.2.0/dist/av-min.js"></script>
<script>
/* LeanCloud åˆå§‹åŒ–ï¼ˆä½ ç»™çš„ appId/appKeyï¼‰ */
AV.init({ appId: 'kCMoxHbSwRcxTuYWaayCMrva-gzGzoHsz', appKey: 'jL0hefBspKv4LQ67m5IzSLF3' });
const DiaryCloud = AV.Object.extend('Diary');
const VisitorCloud = AV.Object.extend('Visitor');
</script>

<script>
// ---------------- é€šç”¨å·¥å…· ----------------
function toast(msg, duration=2200){
  const t=document.getElementById('toast'); t.textContent=msg; t.style.display='block'; t.style.opacity='1';
  setTimeout(()=>{ t.style.opacity='0'; t.style.display='none'; }, duration);
}

function escapeHtml(str){ return String(str).replace(/[&<>"]+/g, function(s){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'})[s] || s; }); }

function formatDate(d){ const dt=new Date(d); return dt.getFullYear()+'-'+String(dt.getMonth()+1).padStart(2,'0')+'-'+String(dt.getDate()).padStart(2,'0'); }

// ---------------- å…ƒç´ å¼•ç”¨ ----------------
const diaryList = document.getElementById('diaryList');
const addDiaryBtn = document.getElementById('addDiaryBtn');
const diaryDate = document.getElementById('diaryDate');
const diaryContent = document.getElementById('diaryContent');
const diaryImg = document.getElementById('diaryImg');
const imgPreviewWrap = document.getElementById('imgPreviewWrap');
const clearFormBtn = document.getElementById('clearFormBtn');
const visitorCountEl = document.getElementById('visitorCount');

let editingDiaryId = null;

// ---------------- å›¾ç‰‡é¢„è§ˆï¼ˆé¿å…ä¸Šä¼ å‰ç”¨æˆ·æ— æ³•ç¡®è®¤ï¼‰ ----------------
diaryImg.addEventListener('change', ()=>{
  imgPreviewWrap.innerHTML='';
  const file = diaryImg.files[0];
  if(!file) return;
  if(file.size > 6 * 1024 * 1024){ // 6MB é™åˆ¶
    toast('å›¾ç‰‡å¤ªå¤§ï¼Œè¯·é€‰æ‹©å°äº 6MB çš„å›¾ç‰‡');
    diaryImg.value=''; return;
  }
  const reader = new FileReader();
  reader.onload = e => {
    const img = document.createElement('img'); img.src = e.target.result; img.className='diary-img';
    imgPreviewWrap.appendChild(img);
  };
  reader.readAsDataURL(file);
});

clearFormBtn.addEventListener('click', ()=>{ diaryDate.value=''; diaryContent.value=''; diaryImg.value=''; imgPreviewWrap.innerHTML=''; editingDiaryId=null; addDiaryBtn.textContent='æ·»åŠ æ—¥è®°'; });

// ---------------- è·å–/æ¸²æŸ“æ—¥è®° ----------------
function renderDiaries(diaries){
  diaryList.innerHTML='';
  if(!diaries || diaries.length===0){ diaryList.innerHTML='<p style="color:#888">è¿˜æ²¡æœ‰æ—¥è®°ï¼Œå†™ä¸€æ¡å§ã€‚</p>'; return; }
  diaries.forEach(d=>{
    const card=document.createElement('div'); card.className='card show';
    let html=`<p style="font-weight:700;"><strong>${escapeHtml(d.date || formatDate(d.createdAt))}</strong> <small style='color:#777;margin-left:8px;'>${d.author || 'åŒ¿å'}</small></p>`;
    html+=`<p style="white-space:pre-wrap;">${escapeHtml(d.content || '')}</p>`;
    if(d.img) html+=`<img src="${d.img}" class="diary-img"/>`;
    html+=`<div style="display:flex;justify-content:center;gap:8px;margin-top:10px;"><button data-id="${d.id}" class="editBtn">ç¼–è¾‘</button><button data-id="${d.id}" class="deleteBtn">åˆ é™¤</button></div>`;
    card.innerHTML=html; diaryList.appendChild(card);
  });

  // ç»‘å®šç¼–è¾‘/åˆ é™¤
  diaryList.querySelectorAll('.editBtn').forEach(btn=> btn.addEventListener('click', e=>{ const id=e.currentTarget.dataset.id; startEditDiary(id); }));
  diaryList.querySelectorAll('.deleteBtn').forEach(btn=> btn.addEventListener('click', e=>{ const id=e.currentTarget.dataset.id; deleteDiary(id); }));
}

function fetchDiariesFromCloud(){
  const query = new AV.Query(DiaryCloud);
  query.descending('createdAt');
  query.limit(1000);
  query.find().then(results => {
    const diaries = results.map(r=>({ id: r.id, date: r.get('date'), content: r.get('content'), img: r.get('img'), createdAt: r.createdAt, author: r.get('author') }));
    renderDiaries(diaries);
  }).catch(err=>{ console.error('æ‹‰å–æ—¥è®°å¤±è´¥', err); toast('æ‹‰å–æ—¥è®°å¤±è´¥'); });
}

// ---------------- æ·»åŠ /ç¼–è¾‘æ—¥è®°ï¼ˆå›¾ç‰‡ä»¥ AV.File å½¢å¼ä¸Šä¼ ï¼‰ ----------------
addDiaryBtn.addEventListener('click', async ()=>{
  const dateVal = diaryDate.value || new Date().toISOString().split('T')[0];
  const contentVal = diaryContent.value.trim();
  if(!contentVal){ alert('è¯·å¡«å†™å†…å®¹'); return; }

  addDiaryBtn.disabled=true; addDiaryBtn.textContent = editingDiaryId ? 'ä¿å­˜ä¸­...' : 'ä¿å­˜ä¸­...';

  try{
    let obj;
    if(editingDiaryId){
      obj = AV.Object.createWithoutData('Diary', editingDiaryId);
      obj.set('date', dateVal); obj.set('content', contentVal);
    }else{
      obj = new DiaryCloud(); obj.set('date', dateVal); obj.set('content', contentVal);
      // è®°å½•ä½œè€…æ ‡è¯†ï¼ˆæœ¬åœ°éšæœº idï¼‰ï¼Œç”¨äºç®€å•çš„ç¼–è¾‘/åˆ é™¤æƒé™åˆ¤æ–­ï¼ˆéå®‰å…¨æœºåˆ¶ï¼‰
      const authorId = localStorage.getItem('happy_author_id') || 'user-' + Math.random().toString(36).slice(2,10);
      localStorage.setItem('happy_author_id', authorId);
      obj.set('author', authorId);
    }

    const file = diaryImg.files[0];
    if(file){
      const fileObj = new AV.File(file.name, file);
      const f = await fileObj.save();
      obj.set('img', f.url());
    }

    await obj.save();
    toast('âœ… æ—¥è®°å·²ä¿å­˜');
    diaryDate.value=''; diaryContent.value=''; diaryImg.value=''; imgPreviewWrap.innerHTML=''; editingDiaryId=null; addDiaryBtn.textContent='æ·»åŠ æ—¥è®°';
    fetchDiariesFromCloud();
  }catch(err){ console.error('ä¿å­˜å¤±è´¥', err); alert('ä¿å­˜å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ§åˆ¶å°æˆ–ç½‘ç»œã€‚'); }
  addDiaryBtn.disabled=false;
});

// ---------------- ç¼–è¾‘/åˆ é™¤åŠŸèƒ½ ----------------
async function startEditDiary(id){
  try{
    const obj = await new AV.Query(DiaryCloud).get(id);
    // ç®€å•æƒé™ï¼šåªæœ‰åˆ›å»ºè€…æœ¬åœ° id åŒ¹é…æ‰å…è®¸ç¼–è¾‘/åˆ é™¤ï¼ˆå¯ç»•è¿‡ï¼Œä»…ä½œä½“éªŒï¼‰
    const myId = localStorage.getItem('happy_author_id') || null;
    if(obj.get('author') && myId && obj.get('author')!==myId){
      if(!confirm('è¿™ä¸æ˜¯ä½ å†™çš„æ—¥è®°ï¼Œè¦ç»§ç»­ç¼–è¾‘è¯·ç¡®è®¤ï¼ˆæ³¨æ„ï¼šè¿™æ˜¯å…¬å¼€å†…å®¹ï¼‰')){ return; }
    }
    diaryDate.value = obj.get('date') || formatDate(obj.createdAt);
    diaryContent.value = obj.get('content') || '';
    imgPreviewWrap.innerHTML='';
    if(obj.get('img')){
      const img=document.createElement('img'); img.src=obj.get('img'); img.className='diary-img'; imgPreviewWrap.appendChild(img);
    }
    editingDiaryId = id; addDiaryBtn.textContent='ä¿å­˜æ›´æ”¹'; window.scrollTo({top:document.getElementById('diaryFormCard').offsetTop-30, behavior:'smooth'});
  }catch(err){ console.error('è¯»å–æ—¥è®°å¤±è´¥', err); alert('è¯»å–å¤±è´¥'); }
}

async function deleteDiary(id){
  if(!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡æ—¥è®°å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤')) return;
  try{
    const obj = AV.Object.createWithoutData('Diary', id);
    await obj.destroy();
    toast('æ—¥è®°å·²åˆ é™¤');
    fetchDiariesFromCloud();
  }catch(err){ console.error('åˆ é™¤å¤±è´¥', err); alert('åˆ é™¤å¤±è´¥'); }
}

// ---------------- è®¿å®¢é‡ï¼šè®°å½•å¹¶ä» LeanCloud è·å–çœŸå®æ•°ï¼ˆæŒ‰å¤©é¿å…é‡å¤è®¡æ•°ï¼‰ ----------------
async function recordVisitor(){
  try{
    const today = new Date().toISOString().split('T')[0];
    const key = 'happy_visitor_' + today;
    if(localStorage.getItem(key)){
      // å½“å¤©å·²è®°å½•ï¼Œç›´æ¥è¯»å–ç»Ÿè®¡
      fetchVisitorCount();
      return;
    }
    // æœ¬åœ°æœªè®°å½•ï¼Œåˆ›å»º Visitor å¯¹è±¡å¹¶ä¿å­˜ï¼ˆè½»é‡ï¼‰
    const v = new VisitorCloud();
    // éšæœº id ç”¨äºå¤§è‡´åŒºåˆ†è®¾å¤‡ï¼ˆä¸æ˜¯å®‰å…¨/éšç§è¿½è¸ªï¼Œä»…ç”¨äºå»é‡ï¼‰
    const deviceId = localStorage.getItem('happy_device_id') || ('dev-' + Math.random().toString(36).slice(2,10));
    localStorage.setItem('happy_device_id', deviceId);
    v.set('deviceId', deviceId);
    v.set('date', today);
    await v.save();
    localStorage.setItem(key, '1');
    fetchVisitorCount();
  }catch(err){ console.error('è®°å½•è®¿å®¢å¤±è´¥', err); fetchVisitorCount(true); }
}

async function fetchVisitorCount(fallback=false){
  try{
    const q = new AV.Query(VisitorCloud);
    const today = new Date().toISOString().split('T')[0];
    q.equalTo('date', today);
    const c = await q.count();
    visitorCountEl.textContent = c;
  }catch(err){ console.error('å–è®¿å®¢é‡å¤±è´¥', err); if(fallback){ const v = parseInt(localStorage.getItem('visitorCount')||0)+1; localStorage.setItem('visitorCount', v); visitorCountEl.textContent = v; } }
}

// ---------------- è¿”å›é¡¶éƒ¨ & å¯¼èˆªæ ·å¼ ----------------
const toTopBtn=document.getElementById('toTopBtn');
window.addEventListener('scroll',()=>{ toTopBtn.style.display=(window.scrollY>200)?'block':'none'; document.getElementById('mainNav').classList.toggle('scrolled', window.scrollY>50); showOnScroll(); });
toTopBtn.addEventListener('click',()=>{ window.scrollTo({top:0, behavior:'smooth'}); });

// ---------------- æ—¥å¤œæ¨¡å¼ ----------------
const modeToggle=document.getElementById('modeToggle');
modeToggle.addEventListener('click',()=>{ document.body.classList.toggle('dark'); initParticles(); localStorage.setItem('happy_dark', document.body.classList.contains('dark')? '1':'0'); });
// æ¢å¤ä¸»é¢˜
if(localStorage.getItem('happy_dark')==='1') document.body.classList.add('dark');

// ---------------- QRå¼¹çª— ----------------
const qrImg=document.getElementById('qrImg');
const qrModal=document.getElementById('qrModal');
qrImg.addEventListener('click',()=>qrModal.classList.add('show'));
qrModal.addEventListener('click', (e)=>{ if(e.target === qrModal) qrModal.classList.remove('show'); });

// ---------------- å¡ç‰‡æ»šåŠ¨åŠ¨ç”» ----------------
function showOnScroll() {
  const cards = document.querySelectorAll('.card');
  const trigger = window.innerHeight*0.85;
  cards.forEach(card => { const top = card.getBoundingClientRect().top; if(top < trigger) card.classList.add('show'); });
}
window.addEventListener('load', ()=>{ fetchDiariesFromCloud(); recordVisitor(); fetchVisitorCount(); showOnScroll(); initParticles(); });

// ---------------- ç²’å­ ----------------
let particles = [];
const canvas = document.getElementById('particles');
const ctx = canvas.getContext('2d');
function initParticles(){
  canvas.width=window.innerWidth; canvas.height=window.innerHeight; particles=[];
  const n = document.body.classList.contains('dark')? 90: 0;
  for(let i=0;i<n;i++){ particles.push({x:Math.random()*canvas.width,y:Math.random()*canvas.height,dx:(Math.random()-0.5)*1.2,dy:(Math.random()-0.5)*1.2,r:Math.random()*2+1}); }
}
function animateParticles(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  for(let p of particles){ p.x += p.dx; p.y += p.dy; if(p.x<0||p.x>canvas.width) p.dx *= -1; if(p.y<0||p.y>canvas.height) p.dy *= -1; ctx.beginPath(); ctx.arc(p.x,p.y,p.r,0,Math.PI*2); ctx.fillStyle='rgba(255,255,255,0.7)'; ctx.fill(); }
  requestAnimationFrame(animateParticles);
}
window.addEventListener('resize', initParticles);
initParticles(); animateParticles();

// ---------------- å¯¼èˆªé«˜äº®ï¼ˆåŸºç¡€ï¼‰ ----------------
const navLinks = document.querySelectorAll('#mainNav a');
function highlightNav(){
  const fromTop = window.scrollY + 60;
  navLinks.forEach(link=>{
    const section = document.querySelector(link.hash);
    if(!section) return;
    if(section.offsetTop <= fromTop && section.offsetTop + section.offsetHeight > fromTop){ link.classList.add('active'); } else link.classList.remove('active');
  });
}
window.addEventListener('scroll', highlightNav); highlightNav();

</script>

<!-- ---------------- Valine è¯„è®ºåŒº ---------------- -->
<script src="https://unpkg.com/valine@1/dist/Valine.min.js"></script>
<script>
/* Valine åˆå§‹åŒ–ï¼šä½¿ç”¨ä½ ç»™çš„ LeanCloud appId/appKey */
new Valine({
  el: '#vcomments',
  appId: 'kCMoxHbSwRcxTuYWaayCMrva-gzGzoHsz',
  appKey: 'jL0hefBspKv4LQ67m5IzSLF3',
  placeholder: 'æ¬¢è¿ç•™è¨€...',
  avatar: 'mp',
  lang: 'zh-CN',
  visitor: true
});
</script>

</body>
</html>
