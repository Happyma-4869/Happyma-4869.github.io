<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<title>Happy çš„ä¸ªäººä¸»é¡µï¼ˆå¸¦å¯äº¤äº’ç«‹ä½“åœ£è¯æ ‘ï¼‰</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
  /* ---------- åŸºç¡€ & è‹¹æœé£æ ¼ ---------- */
  :root{--accent:#007aff}
  html,body{height:100%;margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",sans-serif;overflow-x:hidden; background:#f3f5f8;color:#222;transition:background .4s,color .4s}
  body.dark{background:#0f1113;color:#eaeaea}
  a{color:var(--accent)}
  /* è§†é¢‘ & å±‚æ¬¡ */
  #bgVideo{position:fixed;left:0;top:0;width:100%;height:100%;object-fit:cover;z-index:0;transition:filter .3s}
  body.dark #bgVideo{filter:brightness(.45) contrast(1.1)}
  canvas#particles{position:fixed;left:0;top:0;width:100%;height:100%;z-index:1;pointer-events:none}
  /* åœ£è¯æ ‘å·¦ä¾§å°çª— */
  #treeContainer{
    position:fixed;
    left:20px;
    top:50%;
    transform:translateY(-50%);
    width:220px;height:320px;
    z-index:12;
    border-radius:18px;
    overflow:hidden;
    box-shadow:0 10px 30px rgba(0,0,0,0.25);
    background:linear-gradient(180deg,rgba(255,255,255,0.06),rgba(255,255,255,0.03));
    backdrop-filter: blur(6px);
    cursor:pointer;
    transition:transform .25s ease, box-shadow .25s;
  }
  #treeContainer:hover{transform:translateY(-50%) scale(1.03); box-shadow:0 18px 50px rgba(0,0,0,0.35)}
  #treeSmallCanvas{width:100%;height:100%;display:block}
  /* æ”¾å¤§è¦†ç›–å±‚ (æ¨¡æ€) */
  #treeOverlay{
    position:fixed; inset:0; z-index:9999; display:none; align-items:center; justify-content:center;
    background:rgba(0,0,0,0.45);
  }
  #treeOverlay.show{display:flex}
  #treeOverlay .panel{
    width:min(880px,92%); height:min(720px,84%); border-radius:18px; overflow:hidden;
    background:linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02));
    backdrop-filter: blur(10px);
    box-shadow:0 40px 120px rgba(0,0,0,0.6);
    position:relative;
  }
  #treeOverlay canvas{width:100%;height:100%;display:block}
  #treeClose{
    position:absolute; right:12px; top:12px; z-index:10; background:rgba(0,0,0,0.35); color:#fff; border:none;
    padding:8px 12px; border-radius:12px; cursor:pointer;
  }
  /* é¡µé¢ä¸»ä½“ (ä¿ç•™ä½ åŸæ¥çš„ç»“æ„æ ·å¼) */
  header{position:relative;z-index:5;text-align:center;padding:60px 20px 10px}
  header img{width:140px;height:140px;border-radius:50%;border:4px solid rgba(255,255,255,0.85);display:block;margin:0 auto 12px;object-fit:cover}
  header h1{margin:6px 0;font-size:32px}
  header p{margin:0;color:inherit;opacity:.9}
  nav{position:sticky;top:0;margin:18px auto 0;background:rgba(255,255,255,0.06);padding:8px;border-radius:16px;width:max-content;z-index:5}
  nav a{margin:0 12px;text-decoration:none;color:inherit;font-weight:700}
  /* å¡ç‰‡è‹¹æœé£æ ¼ */
  .card{width:320px;margin:22px auto;padding:22px;border-radius:20px;background:rgba(255,255,255,0.6);backdrop-filter:blur(14px);box-shadow:0 12px 30px rgba(8,12,20,.08);transition:transform .25s}
  body.dark .card{background:rgba(30,30,30,0.6);color:#eee}
  .card:hover{transform:translateY(-6px)}
  .tags{margin-top:10px;text-align:center}
  .tag{display:inline-block;margin:4px;padding:6px 10px;border-radius:14px;background:linear-gradient(90deg,#5ac8fa,#007aff);color:#fff;font-size:13px}
  /* æ—¥è®° */
  textarea,input[type=date]{width:88%;display:block;margin:8px auto;border-radius:14px;padding:10px;border:none;box-shadow:inset 0 2px 8px rgba(0,0,0,0.06)}
  .diary-actions{display:flex;justify-content:center;gap:10px;margin-top:8px}
  button.primary{background:linear-gradient(90deg,#5ac8fa,#007aff);color:#fff;border:none;padding:10px 14px;border-radius:18px;cursor:pointer}
  /* QR å¼¹çª— */
  #qrModal{display:none;position:fixed;inset:0;z-index:40;background:rgba(0,0,0,0.45);align-items:center;justify-content:center}
  #qrModal.show{display:flex}
  #qrModal img{max-width:320px;border-radius:14px;border:6px solid rgba(255,255,255,0.9)}
  /* è¿”å›é¡¶éƒ¨ */
  #toTopBtn{position:fixed;right:28px;bottom:28px;padding:10px 14px;border-radius:20px;border:none;background:linear-gradient(90deg,#4caf50,#2e7d32);color:#fff;cursor:pointer;z-index:20;display:none}
  /* å“åº” */
  @media(max-width:720px){#treeContainer{left:10px;width:140px;height:200px} header img{width:100px;height:100px}}
</style>
</head>
<body>
  <!-- è§†é¢‘èƒŒæ™¯ -->
  <video id="bgVideo" autoplay muted loop playsinline>
    <source src="https://github.com/Happyma-4869/Happyma-4869.github.io/blob/main/Video%20Project%204.mp4?raw=true" type="video/mp4">
  </video>

  <!-- ç²’å­ -->
  <canvas id="particles"></canvas>

  <!-- å·¦ä¾§å°åœ£è¯æ ‘å®¹å™¨ -->
  <div id="treeContainer" title="ç‚¹å‡»ä»¥æ”¾å¤§äº’åŠ¨åœ£è¯æ ‘"></div>

  <!-- æ”¾å¤§äº¤äº’å±‚ -->
  <div id="treeOverlay" aria-hidden="true">
    <div class="panel">
      <button id="treeClose">å…³é—­ âœ•</button>
      <canvas id="treeFullCanvas"></canvas>
    </div>
  </div>

  <!-- é¡µé¢å†…å®¹ï¼ˆä¿ç•™ï¼‰ -->
  <header>
    <img src="https://github.com/Happyma-4869/Happyma-4869.github.io/blob/main/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20251207233412_9_79.jpg?raw=true" alt="å¤´åƒ">
    <h1>æ¬¢è¿æ¥åˆ° Happy çš„ä¸»é¡µ</h1>
    <p>è®°å½•æˆ‘çš„æ—¥å¸¸å’Œç‚¹æ»´ ğŸ˜Š</p>
    <nav id="mainNav">
      <a href="#about">å…³äºæˆ‘</a><a href="#diary">æ—¥è®°</a><a href="#contact">è”ç³»æˆ‘</a>
    </nav>
  </header>

  <div style="height:18px"></div>

  <section id="about">
    <h2 style="color:var(--accent)">å…³äºæˆ‘</h2>
    <div class="card">
      <p>Hi æˆ‘æ˜¯happy  æˆ‘æ¥è‡ªæ²³å—éƒ‘å·å¸‚  ç›®å‰æ˜¯éƒ‘å·å¸‚è¥¿äºšæ–¯å¤§ä¸€å­¦ç”Ÿ  åœ¨æ­¤æˆ‘æƒ³åˆ†äº«æˆ‘çš„ç”Ÿæ´»</p>
      <div class="tags"><span class="tag">å­¦ä¹ </span><span class="tag">æ¸¸æˆ</span><span class="tag">éŸ³ä¹</span><span class="tag">ç¼–ç¨‹</span></div>
    </div>
  </section>

  <section id="diary">
    <h2 style="color:var(--accent)">æˆ‘çš„æ—¥è®° ğŸ“–</h2>
    <div class="card">
      <input type="date" id="diaryDate" />
      <textarea id="diaryContent" rows="4" placeholder="å†™ä¸‹ä»Šå¤©çš„æ—¥è®°..."></textarea>
      <div class="diary-actions"><button id="addDiaryBtn" class="primary">æ·»åŠ æ—¥è®°</button></div>
    </div>
    <div id="diaryList"></div>
  </section>

  <section id="contact">
    <h2 style="color:var(--accent)">è”ç³»æˆ‘</h2>
    <div class="card">
      <p>å¾®ä¿¡ï¼š<strong>H4ppy_ma</strong></p>
      <div class="contact"><div class="qr"><img id="qrImg" src="https://github.com/Happyma-4869/Happyma-4869.github.io/blob/main/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20251207233522_10_79.jpg?raw=true" alt="å¾®ä¿¡äºŒç»´ç " style="width:140px;height:140px;border-radius:14px"></div></div>
    </div>
  </section>

  <footer style="text-align:center;padding:24px 10px;z-index:5">&copy; 2025 Happyma.top</footer>

  <!-- QR æ¨¡æ€ -->
  <div id="qrModal"><img src="https://github.com/Happyma-4869/Happyma-4869.github.io/blob/main/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20251207233522_10_79.jpg?raw=true" alt="äºŒç»´ç å¤§å›¾"></div>

  <!-- è¿”å›é¡¶éƒ¨ -->
  <button id="toTopBtn" aria-label="å›åˆ°é¡¶éƒ¨">â¬†ï¸ é¡¶éƒ¨</button>

  <!-- three.js -->
  <script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.160.0/examples/js/controls/OrbitControls.js"></script>

  <script>
  /* ============================
     æ—¥è®°ï¼ˆlocalStorageï¼‰ + é¡µé¢å¸¸è§„äº¤äº’
     ============================ */
  const diaryList = document.getElementById('diaryList');
  const addDiaryBtn = document.getElementById('addDiaryBtn');
  const diaryDate = document.getElementById('diaryDate');
  const diaryContent = document.getElementById('diaryContent');

  let diaries = JSON.parse(localStorage.getItem('diaries')) || [
    {date:'2025-12-08', content:'ä»Šå¤©æ˜¯æˆ‘åˆæ¬¡åˆ›å»ºæˆ‘çš„ä¸ªäººç½‘ç«™  ç›®å‰è¿˜åœ¨æµ‹è¯•ä¸­  ä»¥åæˆ‘ä¼šé€æ­¥å®Œå–„è€¶âœŒ'}
  ];

  function renderDiaries(){
    diaryList.innerHTML = '';
    diaries.forEach((d, i) => {
      const card = document.createElement('div');
      card.className = 'card';
      card.innerHTML = `<p><strong>${d.date}</strong></p><p>${d.content}</p>
        <div style="display:flex;justify-content:center;gap:8px;margin-top:10px">
          <button onclick="editDiary(${i})" class="primary" style="background:#999;padding:6px 10px">ç¼–è¾‘</button>
          <button onclick="deleteDiary(${i})" class="primary" style="background:#e94f37">åˆ é™¤</button>
        </div>`;
      diaryList.appendChild(card);
    });
    localStorage.setItem('diaries', JSON.stringify(diaries));
  }
  window.editDiary = function(i){
    const nx = prompt('è¯·è¾“å…¥æ–°çš„æ—¥è®°å†…å®¹ï¼š', diaries[i].content);
    if(nx === null) return;
    diaries[i].content = nx;
    renderDiaries();
  };
  window.deleteDiary = function(i){
    if(!confirm('ç¡®å®šåˆ é™¤è¿™ä¸€æ¡æ—¥è®°å—ï¼Ÿ')) return;
    diaries.splice(i,1); renderDiaries();
  };

  addDiaryBtn.addEventListener('click', ()=>{
    const dateVal = diaryDate.value || new Date().toISOString().split('T')[0];
    const contentVal = diaryContent.value.trim();
    if(!contentVal){ alert('è¯·å¡«å†™å†…å®¹'); return; }
    diaries.unshift({date:dateVal, content:contentVal});
    diaryDate.value=''; diaryContent.value='';
    renderDiaries();
  });
  renderDiaries();

  // QR modal
  const qrImg = document.getElementById('qrImg');
  const qrModal = document.getElementById('qrModal');
  qrImg.addEventListener('click', ()=> qrModal.classList.add('show'));
  qrModal.addEventListener('click', ()=> qrModal.classList.remove('show'));

  // toTop
  const toTopBtn = document.getElementById('toTopBtn');
  window.addEventListener('scroll', ()=> { toTopBtn.style.display = (window.scrollY>200) ? 'block' : 'none' });
  toTopBtn.addEventListener('click', ()=> window.scrollTo({top:0, behavior:'smooth'}));

  // nav highlight & card show on scroll
  window.addEventListener('scroll', ()=>{
    document.querySelectorAll('.card').forEach(card=>{
      const r = card.getBoundingClientRect();
      if(r.top < window.innerHeight - 60) card.classList.add('show');
    });
    document.querySelectorAll('#mainNav a').forEach(link=>{
      const sec = document.querySelector(link.getAttribute('href'));
      if(!sec) return;
      if(sec.offsetTop - 80 <= window.scrollY && sec.offsetTop + sec.offsetHeight > window.scrollY) link.classList.add('active');
      else link.classList.remove('active');
    });
  });

  /* ============================
     ç²’å­ï¼ˆç™½è‰²ï¼‰ - ç™½å¤©æ·¡ å¤œé—´äº®
     ============================ */
  const partCanvas = document.getElementById('particles');
  const pctx = partCanvas.getContext('2d');
  let particles = [];
  function resizeParticles(){ partCanvas.width = innerWidth; partCanvas.height = innerHeight; }
  window.addEventListener('resize', resizeParticles);
  resizeParticles();

  let mouse = {x: null, y: null};
  window.addEventListener('mousemove', (e)=> { mouse.x = e.clientX; mouse.y = e.clientY; });

  function initParticles(){
    particles = [];
    const count = document.body.classList.contains('dark') ? 150 : 80;
    for(let i=0;i<count;i++){
      particles.push({
        x: Math.random()*partCanvas.width,
        y: Math.random()*partCanvas.height,
        r: Math.random()*2+1,
        angle: Math.random()*Math.PI*2,
        orbit: Math.random()*20+8,
        speed: Math.random()*0.01+0.004,
        baseX: Math.random()*partCanvas.width,
        baseY: Math.random()*partCanvas.height
      });
    }
  }
  initParticles();
  function drawParticles(){
    pctx.clearRect(0,0,partCanvas.width,partCanvas.height);
    particles.forEach(p=>{
      p.angle += p.speed;
      p.x = p.baseX + Math.cos(p.angle)*p.orbit;
      p.y = p.baseY + Math.sin(p.angle)*p.orbit;
      // å¾®é è¿‘é¼ æ ‡
      if(mouse.x && mouse.y){
        const dx = mouse.x - p.x, dy = mouse.y - p.y;
        const d = Math.sqrt(dx*dx+dy*dy);
        if(d<120){ p.x += dx*0.002; p.y += dy*0.002; }
      }
      pctx.beginPath();
      pctx.fillStyle = document.body.classList.contains('dark') ? 'rgba(255,255,255,0.92)' : 'rgba(255,255,255,0.28)';
      pctx.arc(p.x, p.y, p.r, 0, Math.PI*2);
      pctx.fill();
    });
    requestAnimationFrame(drawParticles);
  }
  drawParticles();

  // night/day toggle affecting particles
  const modeToggle = document.getElementById('modeToggle');
  modeToggle.addEventListener('click', ()=>{
    document.body.classList.toggle('dark');
    initParticles(); // é‡å»ºä»¥æ”¹å˜æ•°é‡/äº®åº¦
  });

  /* ============================
     ä¸‰ç»´åœ£è¯æ ‘ï¼ˆå°çª— + æ”¾å¤§æ¨¡æ€ï¼‰
     - æˆ‘ç”¨åŒä¸€ scene æ¸²æŸ“åˆ°ä¸¤ä¸ª rendererï¼ˆå°çª— + å…¨å±panelï¼‰
     - å°çª—é»˜è®¤å¾®æ—‹è½¬ä¸”ä¸å¯äº¤äº’ï¼Œç‚¹å‡»æ‰“å¼€ overlay åå¯ç”¨äº¤äº’ï¼ˆOrbitControlsï¼‰
     - æ˜Ÿæ˜Ÿé—ªçƒã€ç¯å’Œç¤¼ç›’ç®€å•åŠ¨ç”»
     ============================ */

  // containers & canvases
  const treeContainer = document.getElementById('treeContainer');
  const overlay = document.getElementById('treeOverlay');
  const overlayCanvas = document.getElementById('treeFullCanvas');

  // small renderer & camera
  const smallRenderer = new THREE.WebGLRenderer({antialias:true, alpha:true});
  smallRenderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
  smallRenderer.setSize(treeContainer.clientWidth, treeContainer.clientHeight);
  smallRenderer.domElement.id = 'treeSmallCanvas';
  treeContainer.appendChild(smallRenderer.domElement);

  const smallCamera = new THREE.PerspectiveCamera(50, treeContainer.clientWidth/treeContainer.clientHeight, 0.1, 100);
  smallCamera.position.set(0,1.2,3.0);

  // full renderer & camera (overlay)
  const fullRenderer = new THREE.WebGLRenderer({antialias:true, alpha:true, canvas: overlayCanvas});
  fullRenderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
  fullRenderer.setSize(overlayCanvas.clientWidth || 800, overlayCanvas.clientHeight || 600);

  const fullCamera = new THREE.PerspectiveCamera(50, 1.6, 0.1, 200);
  fullCamera.position.set(0,1.6,4.2);

  // shared scene
  const scene = new THREE.Scene();

  // lights
  const amb = new THREE.AmbientLight(0xffffff, 0.8);
  scene.add(amb);
  const pLight = new THREE.PointLight(0xffffff, 0.9);
  pLight.position.set(4,6,4);
  scene.add(pLight);

  // tree group
  const tree = new THREE.Group();
  scene.add(tree);

  // layered foliage for better depth (several cones)
  const greens = [0x056608, 0x0a8d0a, 0x0f9b1f];
  for(let i=0;i<5;i++){
    const radius = 0.9 - i*0.14;
    const height = 0.9 - i*0.12;
    const geo = new THREE.ConeGeometry(radius, height, 32);
    const mat = new THREE.MeshStandardMaterial({color: greens[i%greens.length], roughness:0.7, metalness:0.05});
    const m = new THREE.Mesh(geo, mat);
    m.position.y = 0.45 + i*0.25;
    m.rotation.y = (Math.random()-0.5)*0.25;
    tree.add(m);
  }

  // trunk
  const trunk = new THREE.Mesh(new THREE.CylinderGeometry(0.12,0.18,0.45,20), new THREE.MeshStandardMaterial({color:0x7b4f2b}));
  trunk.position.y = 0.12;
  tree.add(trunk);

  // star (two-layered for glow)
  const starMat = new THREE.MeshBasicMaterial({color:0xfff08f});
  const starGeo = new THREE.OctahedronGeometry(0.12);
  const star = new THREE.Mesh(starGeo, new THREE.MeshStandardMaterial({color:0xffe27a, emissive:0xfff2a6, emissiveIntensity:1.6}));
  star.position.y = 1.65;
  star.rotation.set(Math.PI,0,0);
  tree.add(star);

  // little decorative lights (spheres with emissive)
  const lampColors = [0xff3b30, 0xffcc00, 0x00a1ff, 0xff2d95, 0x26de8a];
  const lamps = [];
  for(let i=0;i<60;i++){
    const s = 0.055 + Math.random()*0.05;
    const geo = new THREE.SphereGeometry(s, 8, 8);
    const mat = new THREE.MeshStandardMaterial({color: lampColors[i%lampColors.length], emissive: lampColors[i%lampColors.length], emissiveIntensity: 0.9});
    const mesh = new THREE.Mesh(geo, mat);
    // distribute on cone layers
    const layer = Math.floor(Math.random()*5);
    const theta = Math.random()*Math.PI*2;
    const r = (0.25 + layer*0.15) * (1 + Math.random()*0.25);
    mesh.position.set(Math.cos(theta)*r, 0.9 + layer*0.25 + Math.random()*0.05, Math.sin(theta)*r);
    lamps.push({mesh, phase: Math.random()*10});
    tree.add(mesh);
  }

  // gift boxes around base
  const gifts = [];
  const giftColors = [0xff6347, 0xffd700, 0x4db6ff, 0xff8c42, 0x6bff9e];
  for(let i=0;i<8;i++){
    const size = 0.16 + Math.random()*0.08;
    const geo = new THREE.BoxGeometry(size, size*0.65, size);
    const mat = new THREE.MeshStandardMaterial({color: giftColors[i%giftColors.length], roughness:0.6});
    const box = new THREE.Mesh(geo, mat);
    const angle = i*(Math.PI*2/8) + Math.random()*0.25;
    const radius = 0.55 + Math.random()*0.18;
    box.position.set(Math.cos(angle)*radius, size*0.33, Math.sin(angle)*radius);
    box.rotation.y = Math.random()*Math.PI;
    gifts.push({mesh:box, speed: (0.002+Math.random()*0.004)});
    tree.add(box);
  }

  // small ground plane for shadow illusion (not physical shadow)
  const ground = new THREE.Mesh(new THREE.CircleGeometry(1.1, 32), new THREE.MeshBasicMaterial({color:0x000000, opacity:0.06, transparent:true}));
  ground.rotation.x = -Math.PI/2; ground.position.y = 0.01;
  scene.add(ground);

  // initial small camera/look settings done above

  // animation state
  let smallRotation = 0;
  let overlayOpen = false;

  // small render loop
  function renderSmall(){
    smallRenderer.setSize(treeContainer.clientWidth, treeContainer.clientHeight, false);
    smallRenderer.render(scene, smallCamera);
  }
  // small animation
  function animateSmall(){
    if(!overlayOpen){
      smallRotation += 0.002;
      tree.rotation.y = smallRotation;
      // subtle lamp twinkle
      lamps.forEach((l, idx)=> {
        l.mesh.material.emissiveIntensity = 0.6 + 0.6 * Math.abs(Math.sin((Date.now()*0.002) + l.phase));
      });
      gifts.forEach(g => {
        g.mesh.rotation.y += g.speed;
      });
    }
    renderSmall();
    requestAnimationFrame(animateSmall);
  }
  animateSmall();

  // overlay (full) renderer & controls
  const overlayRenderer = fullRenderer; // alias
  function setupOverlay(){
    // adjust size to panel
    const panel = document.querySelector('#treeOverlay .panel');
    const w = panel.clientWidth, h = panel.clientHeight;
    overlayCanvas.width = w; overlayCanvas.height = h;
    overlayRenderer.setSize(w, h, false);
    fullCamera.aspect = w/h; fullCamera.updateProjectionMatrix();
  }
  // prepare orbit controls for overlay
  const overlayControls = new THREE.OrbitControls(fullCamera, overlayCanvas);
  overlayControls.enablePan = false;
  overlayControls.enableZoom = true;
  overlayControls.enableRotate = true;
  overlayControls.enableDamping = true;
  overlayControls.dampingFactor = 0.08;
  overlayControls.autoRotate = false;

  // overlay animation
  function animateOverlay(){
    // star subtle pulse
    const emissiveBase = 1.2 + Math.sin(Date.now()*0.006)*0.6;
    star.material.emissiveIntensity = emissiveBase;
    // lamps twinkle faster on overlay
    lamps.forEach((l)=> {
      l.mesh.material.emissiveIntensity = 0.6 + 1.0 * Math.abs(Math.sin((Date.now()*0.003) + l.phase));
    });
    gifts.forEach(g => { g.mesh.rotation.y += g.speed*1.6; g.mesh.position.y = 0.08 + Math.abs(Math.sin(Date.now()*0.001 + g.speed))*0.06; });
    overlayRenderer.render(scene, fullCamera);
    requestAnimationFrame(animateOverlay);
  }

  // open overlay
  const overlayDiv = document.getElementById('treeOverlay');
  const closeBtn = document.getElementById('treeClose');
  treeContainer.addEventListener('click', openOverlay);
  function openOverlay(){
    if(overlayOpen) return;
    overlayOpen = true;
    overlayDiv.classList.add('show');
    overlayDiv.setAttribute('aria-hidden','false');
    // make overlay canvas match panel
    setupOverlay();
    // position camera slightly farther for full view
    fullCamera.position.set(0,1.6,4.0);
    overlayControls.reset();
    overlayControls.update();
    // allow nicer lighting when overlay open
    pLight.intensity = 1.2;
    amb.intensity = 0.6;
    animateOverlay();
  }
  // close overlay
  closeBtn.addEventListener('click', closeOverlay);
  function closeOverlay(){
    if(!overlayOpen) return;
    overlayOpen = false;
    overlayDiv.classList.remove('show');
    overlayDiv.setAttribute('aria-hidden','true');
    // reset small camera and light
    pLight.intensity = 0.9;
    amb.intensity = 0.8;
  }

  // resize handling
  window.addEventListener('resize', ()=>{
    // small
    smallRenderer.setSize(treeContainer.clientWidth, treeContainer.clientHeight, false);
    smallCamera.aspect = treeContainer.clientWidth / treeContainer.clientHeight;
    smallCamera.updateProjectionMatrix();
    // overlay panel
    if(overlayOpen) setupOverlay();
    // particles
    resizeParticles();
  });

  // ensure overlayCanvas size if panel visible
  window.addEventListener('orientationchange', ()=> { if(overlayOpen) setupOverlay(); });

  /* ============ å¾®ä¼˜åŒ–ï¼šç‚¹å‡»æ ‘å°çª—ä¹Ÿèƒ½åŒå‡»å›åˆ°overlayå…³é—­ ============ */
  treeContainer.addEventListener('dblclick', openOverlay);

  /* ============================
     å°è¡¥ä¸ï¼šå½“é¡µé¢åˆ‡æ¢å¤œé—´æ—¶ï¼Œè°ƒæ•´ä¸€äº›æè´¨äº®åº¦
     ============================ */
  const observer = new MutationObserver(() => {
    const dark = document.body.classList.contains('dark');
    // lamp visibility slightly different
    lamps.forEach(l => { l.mesh.material.emissiveIntensity = dark ? 1.0 : 0.7; });
  });
  observer.observe(document.body, {attributes:true, attributeFilter:['class']});

  // initial sizing to avoid black canvas
  smallRenderer.setSize(treeContainer.clientWidth, treeContainer.clientHeight);
  overlayRenderer.setSize(Math.min(880, window.innerWidth*0.92), Math.min(720, window.innerHeight*0.84));

  // ensure overlay canvas CSS fits parent
  (function ensureOverlayCanvasSize(){
    const panel = document.querySelector('#treeOverlay .panel');
    if(panel){
      overlayCanvas.style.width='100%'; overlayCanvas.style.height='100%';
    }
  })();
  </script>
</body>
</html>
